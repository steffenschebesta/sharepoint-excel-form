<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JS Quote Form</title>
  <style>
    /* Basic styling for demonstration purposes */
    #filtersContainer {
      margin-bottom: 16px;
    }
    select {
      margin-right: 12px;
    }
    #searchContainer {
      margin-bottom: 16px;
      position: relative;
    }
    #searchField {
      width: 200px;
    }
    #suggestions {
      border: 1px solid #ccc;
      max-width: 200px;
      display: none;
      position: absolute;
      background: #fff;
      z-index: 999;
    }
    #suggestions div {
      padding: 4px;
      cursor: pointer;
    }
    #suggestions div:hover {
      background: #e6e6e6;
    }
    #resultArea {
      margin-top: 16px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 700px;
    }
    table thead {
      background-color: #f2f2f2;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    .error {
      color: red;
    }

    /* Popup (modal) styles */
    #quoteModal {
      display: none; 
      position: fixed; 
      z-index: 9999;
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.4);
    }
    #quoteModalContent {
      background-color: #fefefe; 
      margin: 10% auto; 
      padding: 20px; 
      border: 1px solid #888; 
      width: 300px; 
      position: relative;
    }
    #closeModalBtn {
      position: absolute; 
      top: 10px; 
      right: 10px; 
      cursor: pointer; 
      font-weight: bold;
    }
    #quoteModalMessage {
      margin-top: 12px;
      color: green;
    }
  </style>
</head>
<body>

  <h1>Search R&O Capability / Part Number &amp; Request Quote</h1>

  <!-- 1) FILTERS -->
  <div id="filtersContainer">
    <label for="descriptionSelect">R&O Capability / PN Description:</label>
    <select id="descriptionSelect">
      <option value="Any" selected>Any</option>
      <!-- More options added dynamically -->
    </select>

    <label for="platformSelect">Aircraft / Engine Platform:</label>
    <select id="platformSelect">
      <option value="Any" selected>Any</option>
      <!-- More options added dynamically -->
    </select>
  </div>

  <!-- 2) SEARCH & AUTOCOMPLETE -->
  <div id="searchContainer">
    <input type="text" id="searchField" placeholder="Type part number..." />
    <div id="suggestions"></div>
    <button id="searchBtn">Search R&O Capability / Part Number</button>
  </div>

  <!-- 3) RESULTS AREA (TABLE) -->
  <div id="resultArea"></div>

  <!-- 4) MODAL / POPUP -->
  <div id="quoteModal">
    <div id="quoteModalContent">
      <span id="closeModalBtn">&times;</span>
      <h2>Request Quote</h2>

      <div>
        <input type="text" id="firstName" placeholder="First Name" /><br/><br/>
        <input type="text" id="lastName" placeholder="Last Name" /><br/><br/>
        <input type="text" id="company" placeholder="Company Name" /><br/><br/>
        <input type="email" id="email" placeholder="Email Address" /><br/><br/>
      </div>

      <button id="submitQuoteBtn">Submit</button>
      <div id="quoteModalMessage"></div>
    </div>
  </div>

  <!-- Include the xlsx library from a CDN (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    /*******************************************************
     * CONFIGURATION
     *******************************************************/
    const EXCEL_FILE_PATH = "Parts.xlsx";
    
    // Column headers in the Excel:
    const PART_NUMBER_COL = "Part Number";
    const DESCRIPTION_COL = "Description";
    const PLATFORM_COL = "Aircraft / Engine Platform";

    // This will hold the parsed Excel rows (array of objects)
    let excelData = [];

    // Keep track of the current filters
    let selectedDescription = "Any";
    let selectedPlatform = "Any";

    /*******************************************************
     * 1) LOAD EXCEL DATA
     *******************************************************/
    async function loadExcelData() {
      try {
        const response = await fetch(EXCEL_FILE_PATH);
        if (!response.ok) {
          throw new Error("Could not fetch the Excel file. Check your local server path or file name.");
        }
        const arrayBuffer = await response.arrayBuffer();
        // Parse with SheetJS
        const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: "array" });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        // Convert to array of objects
        excelData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        // Once loaded, populate the dropdown options
        populateDropdowns();
      } catch (err) {
        console.error("Error loading Excel file:", err);
      }
    }

    // Call the loader once the page is loaded
    loadExcelData();

    /*******************************************************
     * 2) POPULATE DROPDOWNS
     *******************************************************/
    const descriptionSelect = document.getElementById("descriptionSelect");
    const platformSelect = document.getElementById("platformSelect");

    function populateDropdowns() {
      // Get unique values for Description
      const uniqueDescriptions = [...new Set(excelData.map(row => row[DESCRIPTION_COL]))]
        .filter(val => val) // remove empty
        .sort();

      // Get unique values for Platform
      const uniquePlatforms = [...new Set(excelData.map(row => row[PLATFORM_COL]))]
        .filter(val => val)
        .sort();
      
      // Reset the dropdowns (keep "Any")
      resetSelect(descriptionSelect);
      resetSelect(platformSelect);

      // Add each unique description
      uniqueDescriptions.forEach(desc => {
        const opt = document.createElement("option");
        opt.value = desc;
        opt.textContent = desc;
        descriptionSelect.appendChild(opt);
      });

      // Add each unique platform
      uniquePlatforms.forEach(plat => {
        const opt = document.createElement("option");
        opt.value = plat;
        opt.textContent = plat;
        platformSelect.appendChild(opt);
      });
    }

    function resetSelect(selectElem) {
      // Keep the first child "Any", remove others
      while (selectElem.options.length > 1) {
        selectElem.remove(1);
      }
    }

    /*******************************************************
     * 3) SYNC DROPDOWNS (DYNAMIC FILTERING)
     *******************************************************/
    descriptionSelect.addEventListener("change", (e) => {
      selectedDescription = e.target.value;
      // Filter the possible platform options based on selection
      updatePlatformOptions();
      // Also update the suggestions
      updateSuggestions();
      // Clear results
      document.getElementById("resultArea").innerHTML = "";
    });

    platformSelect.addEventListener("change", (e) => {
      selectedPlatform = e.target.value;
      // Filter the possible description options based on selection
      updateDescriptionOptions();
      // Update suggestions
      updateSuggestions();
      // Clear results
      document.getElementById("resultArea").innerHTML = "";
    });

    function updatePlatformOptions() {
      // We want to keep track of the user's old selection if valid
      const oldPlatformSelection = platformSelect.value;
      const filteredData = getFilteredData({ ignorePlatform: true });
      // Get new set of unique platforms from this filtered data
      const newPlatforms = [...new Set(filteredData.map(row => row[PLATFORM_COL]))]
        .filter(val => val)
        .sort();

      resetSelect(platformSelect);
      newPlatforms.forEach(plat => {
        const opt = document.createElement("option");
        opt.value = plat;
        opt.textContent = plat;
        platformSelect.appendChild(opt);
      });

      // If the old selection is still valid, keep it. Otherwise default to "Any"
      if (newPlatforms.includes(oldPlatformSelection)) {
        platformSelect.value = oldPlatformSelection;
      } else {
        platformSelect.value = "Any";
        selectedPlatform = "Any";
      }
    }

    function updateDescriptionOptions() {
      const oldDescSelection = descriptionSelect.value;
      const filteredData = getFilteredData({ ignoreDescription: true });
      // Get new set of unique descriptions from this filtered data
      const newDescs = [...new Set(filteredData.map(row => row[DESCRIPTION_COL]))]
        .filter(val => val)
        .sort();

      resetSelect(descriptionSelect);
      newDescs.forEach(desc => {
        const opt = document.createElement("option");
        opt.value = desc;
        opt.textContent = desc;
        descriptionSelect.appendChild(opt);
      });

      if (newDescs.includes(oldDescSelection)) {
        descriptionSelect.value = oldDescSelection;
      } else {
        descriptionSelect.value = "Any";
        selectedDescription = "Any";
      }
    }

    /*******************************************************
     * 4) AUTOCOMPLETE
     *******************************************************/
    const searchField = document.getElementById("searchField");
    const suggestionsBox = document.getElementById("suggestions");
    
    searchField.addEventListener("input", function () {
      updateSuggestions();
    });

    // Hide suggestions on blur (with small delay to allow clicks)
    searchField.addEventListener("blur", function() {
      setTimeout(() => {
        suggestionsBox.style.display = "none";
      }, 150);
    });

    function updateSuggestions() {
      const query = searchField.value.trim().toLowerCase();
      const filteredData = getFilteredData();

      let matchedPartNumbers = [];
      if (query) {
        matchedPartNumbers = filteredData
          .map(row => row[PART_NUMBER_COL]?.toString())
          .filter(val => val && val.toLowerCase().includes(query));
      }

      if (!query || matchedPartNumbers.length === 0) {
        suggestionsBox.style.display = "none";
        return;
      }

      // Limit to 10 suggestions
      const maxSuggestions = 10;
      const displayed = matchedPartNumbers.slice(0, maxSuggestions);

      suggestionsBox.innerHTML = "";

      displayed.forEach((pn) => {
        const item = document.createElement("div");
        item.textContent = pn;
        item.addEventListener("click", function () {
          // On click, fill the searchField
          searchField.value = pn;
          suggestionsBox.innerHTML = "";
          suggestionsBox.style.display = "none";
        });
        suggestionsBox.appendChild(item);
      });

      // If more than 10 matches, show a final row
      if (matchedPartNumbers.length > maxSuggestions) {
        const remainder = matchedPartNumbers.length - maxSuggestions;
        const moreItem = document.createElement("div");
        moreItem.textContent = `and ${remainder} more results`;
        moreItem.style.fontStyle = "italic";
        moreItem.style.cursor = "default";
        suggestionsBox.appendChild(moreItem);
      }

      suggestionsBox.style.display = "block";
    }

    /*******************************************************
     * 5) SEARCH BUTTON & RESULTS
     *******************************************************/
    const searchBtn = document.getElementById("searchBtn");
    const resultArea = document.getElementById("resultArea");

    searchBtn.addEventListener("click", function () {
      renderResults();
    });

    // Renders the table of matching results
    function renderResults() {
      const query = searchField.value.trim();
      const filtered = getFilteredData();

      // If user typed something, further fuzzy filter by Part Number
      let finalResults = filtered;
      if (query) {
        const qLower = query.toLowerCase();
        finalResults = finalResults.filter(row =>
          row[PART_NUMBER_COL]?.toString().toLowerCase().includes(qLower)
        );
      }

      if (finalResults.length === 0) {
        resultArea.innerHTML = `<span class='error'>No matches found.</span>`;
        return;
      }

      // Build a table
      let html = `<table>
        <thead>
          <tr>
            <th>Part Number</th>
            <th>Description</th>
            <th>Platform</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      // For each row, highlight the matched substring in Part Number
      for (const row of finalResults) {
        const highlightedPN = highlightMatch(row[PART_NUMBER_COL], query);
        const desc = row[DESCRIPTION_COL] || "";
        const plat = row[PLATFORM_COL] || "";

        html += `<tr>
          <td>${highlightedPN}</td>
          <td>${desc}</td>
          <td>${plat}</td>
          <td><button class="requestQuoteBtn">Request Quote</button></td>
        </tr>`;
      }

      html += `</tbody></table>`;
      resultArea.innerHTML = html;

      // Attach event listeners for each "Request Quote" button
      const quoteButtons = document.querySelectorAll(".requestQuoteBtn");
      quoteButtons.forEach((btn, index) => {
        btn.addEventListener("click", () => {
          // Open modal for the corresponding row
          const rowData = finalResults[index];
          openQuoteModal(rowData);
        });
      });
    }

    // Helper to highlight fuzzy match in the Part Number
    function highlightMatch(text = "", query = "") {
      if (!query) return text;
      const regex = new RegExp(query, "gi");
      return text.replace(regex, (match) => `<strong>${match}</strong>`);
    }

    // Returns data filtered by dropdown selections
    // Pass optional flags { ignoreDescription: true } or { ignorePlatform: true }
    // to skip filtering for that column when we re-populate the other.
    function getFilteredData({ ignoreDescription = false, ignorePlatform = false } = {}) {
      return excelData.filter(row => {
        const descCheck = ignoreDescription || selectedDescription === "Any" 
          ? true 
          : row[DESCRIPTION_COL] === selectedDescription;
        const platCheck = ignorePlatform || selectedPlatform === "Any"
          ? true
          : row[PLATFORM_COL] === selectedPlatform;
        return descCheck && platCheck;
      });
    }

    /*******************************************************
     * 6) QUOTE MODAL HANDLING
     *******************************************************/
    const quoteModal = document.getElementById("quoteModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const submitQuoteBtn = document.getElementById("submitQuoteBtn");
    const quoteModalMessage = document.getElementById("quoteModalMessage");

    function openQuoteModal(partData) {
      // Clear previous messages and form fields
      quoteModalMessage.textContent = "";
      document.getElementById("firstName").value = "";
      document.getElementById("lastName").value = "";
      document.getElementById("company").value = "";
      document.getElementById("email").value = "";

      // Show modal
      quoteModal.style.display = "block";

      submitQuoteBtn.onclick = function () {
        const firstName = document.getElementById("firstName").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const company = document.getElementById("company").value.trim();
        const email = document.getElementById("email").value.trim();

        // Basic presence check
        if (!firstName || !lastName || !company || !email) {
          quoteModalMessage.style.color = "red";
          quoteModalMessage.textContent = "Please fill in all fields.";
          return;
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          quoteModalMessage.style.color = "red";
          quoteModalMessage.textContent = "Please enter a valid email address.";
          return;
        }

        // Construct subject & body
        const subject = encodeURIComponent("New Quote Requested");
        let bodyText = `Hello,
I would like to request a quote for the following part:

`;
        // Add part details
        for (const [k, v] of Object.entries(partData)) {
          bodyText += `${k}: ${v}\n`;
        }

        // Add requestor info
        bodyText += `\nRequestor Information:\n`;
        bodyText += `First Name: ${firstName}\n`;
        bodyText += `Last Name: ${lastName}\n`;
        bodyText += `Company: ${company}\n`;
        bodyText += `Email: ${email}\n`;

        const body = encodeURIComponent(bodyText);

        // Attempt to open in a new tab
        const mailtoLink = `mailto:stschebesta@gmail.com?subject=${subject}&body=${body}`;
        window.open(mailtoLink, "_blank");

        // Show success message
        quoteModalMessage.style.color = "green";
        quoteModalMessage.textContent = "Success! The quote request has been triggered.";
      };
    }

    // Close modal on X button
    closeModalBtn.onclick = function () {
      quoteModal.style.display = "none";
    };

    // Close modal if click outside
    window.onclick = function (event) {
      if (event.target === quoteModal) {
        quoteModal.style.display = "none";
      }
    };
  </script>
</body>
</html>
